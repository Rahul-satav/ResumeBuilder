let state={name:'Rahul Satav',title:'Java Full‑Stack Developer',contact:'Pune, India • rahul@example.com • +91-90000 00000',summary:'4.5+ years building scalable Java + React apps. Strong in Spring Boot, REST APIs, SQL, and cloud deployment.',skills:['Java','Spring Boot','REST API','React','SQL','AWS','Docker'],experience:[{role:'Software Engineer',company:'Acme Corp',period:'2021–Present',bullets:['Built microservices with Spring Boot and REST, reducing latency by 35%.','Designed React dashboards improving analytics adoption by 40%.','Automated CI/CD with GitHub Actions and Docker.']}],education:'B.E. in Computer Engineering — 2019',jd:'',extractedText:''};function renderPreview(){const pv=document.getElementById('preview');pv.innerHTML=`<div style="display:flex;align-items:center;justify-content:space-between"><div><div style="font-size:28px;font-weight:800">${escapeHTML(state.name)}</div><div>${escapeHTML(state.title)}</div></div><div>${escapeHTML(state.contact)}</div></div><hr class='sep'/>${section('Summary',`<p>${escapeHTML(state.summary)}</p>`)}${section('Skills',`<div>${state.skills.map(s=>`<span class='skill'>${escapeHTML(s)}</span>`).join(' ')}</div>`)}${section('Experience',state.experience.map(exp=>`<div><b>${escapeHTML(exp.role)}</b> — ${escapeHTML(exp.company)} <span class='small'>(${escapeHTML(exp.period)})</span></div><ul>${exp.bullets.map(b=>`<li>${escapeHTML(b)}</li>`).join('')}</ul>`).join('<br/>'))}${section('Education',`<p>${escapeHTML(state.education)}</p>`)}`;}function section(t,b){return `<div><div class='section-title'>${t}</div>${b}</div>`}function escapeHTML(s){return (s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]))}function refreshEditors(){document.getElementById('name').value=state.name;document.getElementById('title').value=state.title;document.getElementById('contact').value=state.contact;document.getElementById('summary').value=state.summary;document.getElementById('education').value=state.education;document.getElementById('skills').value=state.skills.join(', ');document.getElementById('jd').value=state.jd;}function saveLocal(){localStorage.setItem('airesume-state',JSON.stringify(state))}function loadLocal(){try{const s=localStorage.getItem('airesume-state');if(s){state=JSON.parse(s)}}catch{}}async function onPdfUpload(file){const text=await extractPdfText(file);state.extractedText=text;const email=text.match(/[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/);if(email){state.contact=state.contact.replace(/[^•]+@[^•]+/,email[0])}renderPreview();saveLocal();document.getElementById('extracted').textContent='PDF extracted. Text length: '+text.length+' chars.';}function applyJD(){const jd=document.getElementById('jd').value||'';state.jd=jd;const found=matchSkillsFromJD(jd);const set=new Set([...state.skills,...found]);state.skills=Array.from(set);document.getElementById('jd-found').innerHTML=found.length?'Added based on JD: '+found.map(s=>`<span class='tag'>${s}</span>`).join(' '):'No new skills found in JD.';renderPreview();saveLocal();}function updateATS(){const t=[state.name,state.title,state.contact,state.summary,state.education,...state.skills,...(state.experience?.flatMap(e=>[e.role,e.company,...(e.bullets||[])]))].join(' ');const {score,coverage,jdSkills,matches}=computeATSScore(t,state.skills,state.jd);const el=document.getElementById('ats-result');el.innerHTML=`<div class='progress'><div style='width:${score}%'></div></div><div style="margin-top:6px">ATS Score: <b>${score}/100</b> • JD Match: <b>${coverage}%</b> (${matches}/${jdSkills.length})</div>`;}function wire(){loadLocal();refreshEditors();renderPreview();updateATS();document.getElementById('name').addEventListener('input',e=>{state.name=e.target.value;renderPreview();saveLocal();updateATS()});document.getElementById('title').addEventListener('input',e=>{state.title=e.target.value;renderPreview();saveLocal();updateATS()});document.getElementById('contact').addEventListener('input',e=>{state.contact=e.target.value;renderPreview();saveLocal();updateATS()});document.getElementById('summary').addEventListener('input',e=>{state.summary=e.target.value;renderPreview();saveLocal();updateATS()});document.getElementById('education').addEventListener('input',e=>{state.education=e.target.value;renderPreview();saveLocal();updateATS()});document.getElementById('skills').addEventListener('input',e=>{state.skills=e.target.value.split(',').map(s=>s.trim()).filter(Boolean);renderPreview();saveLocal();updateATS()});document.getElementById('pdf').addEventListener('change',e=>{const f=e.target.files?.[0];if(f)onPdfUpload(f)});document.getElementById('applyJD').addEventListener('click',()=>{applyJD();updateATS()});document.getElementById('export').addEventListener('click',async()=>{const target=document.getElementById('preview');const canvas=await html2canvas(target,{scale:2});const img=canvas.toDataURL('image/png');const pdf=new jspdf.jsPDF(target.clientWidth>target.clientHeight?'l':'p','pt',[target.clientWidth,target.clientHeight]);pdf.addImage(img,'PNG',0,0,target.clientWidth,target.clientHeight);pdf.save('AIResume.pdf')});document.getElementById('themeToggle').addEventListener('click',()=>{window.__toggleTheme()});updateATS()}window.addEventListener('DOMContentLoaded',wire);